var divwhtk=null,inputwhtk=null,owhtk=null,awhtk=null,fileObjectId="",newDiv=null,newSelect=null,tempResult=null,classbanji=null,select_banji=null,networktimu=null;function queryAV(e,t,n,i){return new AV.Query(e).find().then((e=>{for(var l="<datalist>",a=0;a<e.length;a++)l+=null==i?'<option value="'+e[a].attributes[n]+'">'+e[a].attributes[n]+"</option>":'<option value="'+e[a].attributes[n]+'">'+e[a].attributes[i]+"</option>";return l+="</datalist>",newSelect=document.getElementById(t).innerHTML=l,e}))}function querynoquery(e,t,n,i){if(null!=e){e=e._result,console.log(e);for(var l="<datalist>",a=0;a<e.length;a++)l+=null==i?'<option value="'+e[a].attributes[n]+'">'+e[a].attributes[n]+"</option>":'<option value="'+e[a].attributes[n]+'">'+e[a].attributes[i]+"</option>";l+="</datalist>",newSelect=document.getElementById(t).innerHTML=l}else alert("数据没加载，请刷新")}function loadingWindow(){null==divwhtk&&(divwhtk=document.getElementById("csswhtk")),null==newDiv&&((newDiv=document.createElement("div")).innerHTML="<img style=“overflow:auto; src='/images/loading1.gif'></img> 上传中... ",newDiv.style.cssText="display:block; position:relative; width:100%; height:100%;border:3px solid orange;background-color:#FFF8DC ; overflow:auto; text-align: center;")}function fanhui(){divwhtk.innerHTML='<div><label  id="labelwhtk">学号</label>  <input id="xuehao" type="text" name="xuehao"/> </br> \n<label  id="labelwhtk2">姓名</label>  <input id="xingming" type="text" name="xingming"/> </br> \n<label  id="labelwhtk3">班级</label>  <select  id="banji"  name="banji" list=\'banjilist\'><datalist id=\'banjilist\'></datalist>  \n </select></div><div><label  id="inputwhtk">请选择文件</label> \n<span  className = "myupload" id = "myupload">\n       <em> 添加文件 </em>\n    <input id="fileupload" type="file" name="file1" style="display:none"/> \n</span> <input type="button" value="上传" onclick="upload()"/> </input> \n</div>',owhtk=document.getElementById("myupload"),awhtk=owhtk.getElementsByTagName("input")[0],loadingWindow(),owhtk.onclick=function(){awhtk.click()},inputwhtk=document.getElementById("inputwhtk"),awhtk.onchange=function(){inputwhtk.innerText=awhtk.files[0].name},console.log(classbanji),querynoquery(classbanji,"banji","banjiName",null)}function delyunfile(e){AV.File.createWithoutData(e).destroy(),alert("已删除"),fanhui()}window.addEventListener("load",(e=>{if(null!=(divwhtk=document.getElementById("csswhtk"))){inputwhtk=document.getElementById("inputwhtk"),owhtk=document.getElementById("myupload"),awhtk=owhtk.getElementsByTagName("input")[0],newSelect=document.getElementById("banji"),loadingWindow(),owhtk.onclick=function(){awhtk.click()},awhtk.onchange=function(){inputwhtk.innerText=awhtk.files[0].name},null==classbanji?classbanji=queryAV("banji","banji","banjiName",null):querynoquery(classbanji,"banji","banjiName",null)}null!=(select_banji=document.getElementById("select_banji"))&&(null==classbanji?classbanji=queryAV("banji","select_banji","banjiName",null):querynoquery(classbanji,"select_banji","banjiName",null),null==networktimu?networktimu=queryAV("networkNum","select_shiyan","shiyanname",null):querynoquery(networktimu,"select_shiyan","shiyanname",null))}));var submitcount=0,xuehao=null,xingming=null,banjiSelect=null;function upload(){if(0==submitcount){xuehao=document.getElementById("xuehao"),xingming=document.getElementById("xingming"),banjiSelect=document.getElementById("banji"),inputwhtk=document.getElementById("inputwhtk");var e=document.getElementById("fileupload");if(""==xuehao.value.trim()||""==xingming.value.trim())return void alert("学号或姓名不能为空");if("2019"!=xuehao.value.trim().substring(0,4)||11!=xuehao.value.length)return void alert("学号有错");if(0==e.files.length)return void alert("请选择一个文件");if(e.files.length){submitcount=1;e.files[0].name;var t=(banjiSelect=document.getElementById("banji")).value,n=t+"-"+document.title+"-"+xuehao.value.trim()+"-"+xingming.value.trim(),i=t+"-"+document.title+"-"+xuehao.value.trim(),l="",a="",u=new AV.Query("_File");u.contains("name",i);u.find().then((t=>{if(t.length>0)alert("你已经上传过了,请先删除"),!0,a=t[0].id,n=t[0].attributes.name,l=t[0].attributes.url,divwhtk.innerHTML="<a id=\"yunfile\"  target='_blank' href="+l+">"+n+'</a> <br><input type="button" value="删除" onclick=delyunfile(\''+a+'\')></input><input type="button" value="返回" onclick=fanhui()></input>',n="",e="",!1,l="",a="",u="",submitcount=0;else{var i=new AV.File(n,e.files[0]),o=!0;i.save({onprogress:e=>{null==newDiv&&loadingWindow(),o&&(divwhtk.innerHTML=newDiv.outerHTML,o=!1)}}).then((e=>{o=!0,a=i.id,divwhtk.innerHTML="<a id=\"yunfile\"  target='_blank' href="+e.url()+">"+n+'</a> <br><input type="button" value="删除" onclick=delyunfile(\''+a+'\')></input><input type="button" value="返回" onclick=fanhui()></input>',n="",e="",!1,l="",a="",u="",e=null,submitcount=0})).catch((function(){console.error,submitcount=0,e=null}))}}))}}else alert("正在操作，请不要重复上传，谢谢！")}var search_resultstemp=null;function shiyandown(e){console.log(e),window.open(e.id)}function shiyandelete(e){console.log(e.id);var t=search_resultstemp;t=t.filter((function(t){return t.id!=e.id})),console.log(t);var n=document.getElementById("searchResult");n.innerHTML="",shiyanrefresh(t,n);AV.File.createWithoutData(e.id).destroy(),search_resultstemp=t}function shiyanrefresh(e,t){if(t.innerHTML="",e.length>0){for(var n='<div id="nav1">',i=0;i<e.length;i++)n+="<ul>",n+="<li>"+(i+1)+"</li><li>"+e[i].attributes.name+"</li><li><input type='button' onclick=shiyandown(this) value='下载' id='"+e[i].attributes.url+"'></li><li><input type='button' onclick=shiyandelete(this) id='"+e[i].id+"' value='删除'></input></li>",n+="</ul>";n+="</div>",t.innerHTML=n}else alert("没人提交")}function network_search(){search_resultstemp=null;var e,t=document.getElementById("select_banji").value,n=document.getElementById("select_shiyan").value,i=document.getElementById("select_xuehao");e=i.value.trim();var l=document.getElementById("searchResult"),a=t+"-"+n;""!=e&&(a=a+" | 一剑飘飘-"+e),console.log(a);var u=new AV.Query("_File");u.startsWith("name",a),u.find().then((e=>{search_resultstemp=e,shiyanrefresh(e,l)})),i.value=""}