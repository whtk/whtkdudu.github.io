var divwhtk=null,inputwhtk=null,owhtk=null,awhtk=null,fileObjectId="",newDiv=null,newSelect=null,tempResult=null,classbanji=null,select_banji=null,networktimu=null;function queryAV(e,n,t,l){return new AV.Query(e).find().then((e=>{for(var i="<datalist>",a=0;a<e.length;a++)i+=null==l?'<option value="'+e[a].attributes[t]+'">'+e[a].attributes[t]+"</option>":'<option value="'+e[a].attributes[t]+'">'+e[a].attributes[l]+"</option>";return i+="</datalist>",newSelect=document.getElementById(n).innerHTML=i,e}))}function querynoquery(e,n,t,l){if(null!=e){e=e._result,console.log(e);for(var i="<datalist>",a=0;a<e.length;a++)i+=null==l?'<option value="'+e[a].attributes[t]+'">'+e[a].attributes[t]+"</option>":'<option value="'+e[a].attributes[t]+'">'+e[a].attributes[l]+"</option>";i+="</datalist>",newSelect=document.getElementById(n).innerHTML=i}else alert("数据没加载，请刷新")}function loadingWindow(){null==divwhtk&&(divwhtk=document.getElementById("csswhtk")),null==newDiv&&((newDiv=document.createElement("div")).innerHTML="<img style=“overflow:auto; src='/images/loading1.gif'></img> 上传中... ",newDiv.style.cssText="display:block; position:relative; width:100%; height:100%;border:3px solid orange;background-color:#FFF8DC ; overflow:auto; text-align: center;")}function fanhui(){divwhtk.innerHTML='<div><label  id="labelwhtk">学号</label>  <input id="xuehao" type="text" name="xuehao"/> </br> \n<label  id="labelwhtk2">姓名</label>  <input id="xingming" type="text" name="xingming"/> </br> \n<label  id="labelwhtk3">班级</label>  <select  id="banji"  name="banji" list=\'banjilist\'><datalist id=\'banjilist\'></datalist>  \n </select></div><div><label  id="inputwhtk">请选择文件</label> \n<span  className = "myupload" id = "myupload">\n       <em> 添加文件 </em>\n    <input id="fileupload" type="file" name="file1" style="display:none"/> \n</span> <input type="button" value="上传" onclick="upload()"/> </input> \n</div>',owhtk=document.getElementById("myupload"),awhtk=owhtk.getElementsByTagName("input")[0],loadingWindow(),owhtk.onclick=function(){awhtk.click()},inputwhtk=document.getElementById("inputwhtk"),awhtk.onchange=function(){inputwhtk.innerText=awhtk.files[0].name},console.log(classbanji),querynoquery(classbanji,"banji","banjiName",null)}function delyunfile(e){AV.File.createWithoutData(e).destroy(),alert("已删除"),fanhui()}window.addEventListener("load",(e=>{if(null!=(divwhtk=document.getElementById("csswhtk"))){inputwhtk=document.getElementById("inputwhtk"),owhtk=document.getElementById("myupload"),awhtk=owhtk.getElementsByTagName("input")[0],newSelect=document.getElementById("banji"),loadingWindow(),owhtk.onclick=function(){awhtk.click()},awhtk.onchange=function(){inputwhtk.innerText=awhtk.files[0].name},null==classbanji?classbanji=queryAV("banji","banji","banjiName",null):querynoquery(classbanji,"banji","banjiName",null)}null!=(select_banji=document.getElementById("select_banji"))&&(null==classbanji?classbanji=queryAV("banji","select_banji","banjiName",null):querynoquery(classbanji,"select_banji","banjiName",null),null==networktimu?networktimu=queryAV("networkNum","select_shiyan","shiyanname",null):querynoquery(networktimu,"select_shiyan","shiyanname",null))}));var xuehao=null,xingming=null,banjiSelect=null;function upload(){xuehao=document.getElementById("xuehao"),xingming=document.getElementById("xingming"),banjiSelect=document.getElementById("banji"),inputwhtk=document.getElementById("inputwhtk");var e=document.getElementById("fileupload");if(""!=xuehao.value.trim()&&""!=xingming.value.trim())if("2019"==xuehao.value.trim().substring(0,4)&&11==xuehao.value.length)if(0!=e.files.length){if(e.files.length){e.files[0].name;var n=(banjiSelect=document.getElementById("banji")).value,t=n+"-"+document.title+"-"+xuehao.value.trim()+"-"+xingming.value.trim(),l=n+"-"+document.title+"-"+xuehao.value.trim(),i="",a="",u=new AV.Query("_File");u.contains("name",l);u.find().then((n=>{if(n.length>0)alert("你已经上传过了,请先删除"),!0,a=n[0].id,t=n[0].attributes.name,i=n[0].attributes.url,divwhtk.innerHTML="<a id=\"yunfile\"  target='_blank' href="+i+">"+t+'</a> <br><input type="button" value="删除" onclick=delyunfile(\''+a+'\')></input><input type="button" value="返回" onclick=fanhui()></input>',t="",e="",!1,i="",a="",u="";else{var l=new AV.File(t,e.files[0]),o=!0;l.save({onprogress:e=>{null==newDiv&&loadingWindow(),o&&(divwhtk.innerHTML=newDiv.outerHTML,o=!1)}}).then((e=>{o=!0,a=l.id,divwhtk.innerHTML="<a id=\"yunfile\"  target='_blank' href="+e.url()+">"+t+'</a> <br><input type="button" value="删除" onclick=delyunfile(\''+a+'\')></input><input type="button" value="返回" onclick=fanhui()></input>',t="",e="",!1,i="",a="",u=""})).catch(console.error)}}))}}else alert("请选择一个文件");else alert("学号有错");else alert("学号或姓名不能为空")}var search_resultstemp=null;function shiyandown(e){console.log(e),window.open(e.id)}function shiyandelete(e){console.log(e.id);var n=search_resultstemp;n=n.filter((function(n){return n.id!=e.id})),console.log(n);var t=document.getElementById("searchResult");t.innerHTML="",shiyanrefresh(n,t);AV.File.createWithoutData(e.id).destroy(),search_resultstemp=n}function shiyanrefresh(e,n){if(n.innerHTML="",e.length>0){for(var t='<div id="nav1">',l=0;l<e.length;l++)t+="<ul>",t+="<li>"+(l+1)+"</li><li>"+e[l].attributes.name+"</li><li><input type='button' onclick=shiyandown(this) value='下载' id='"+e[l].attributes.url+"'></li><li><input type='button' onclick=shiyandelete(this) id='"+e[l].id+"' value='删除'></input></li>",t+="</ul>";t+="</div>",n.innerHTML=t}else alert("没人提交")}function network_search(){search_resultstemp=null;var e,n=document.getElementById("select_banji").value,t=document.getElementById("select_shiyan").value,l=document.getElementById("select_xuehao");e=l.value.trim();var i=document.getElementById("searchResult"),a=n+"-"+t;""!=e&&(a=a+" | 一剑飘飘-"+e),console.log(a);var u=new AV.Query("_File");u.startsWith("name",a),u.find().then((e=>{search_resultstemp=e,shiyanrefresh(e,i)})),l.value=""}